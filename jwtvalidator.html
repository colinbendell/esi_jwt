<esi:comment text="
---- WARNING: GENERATED ESI ----
"/><esi:function name="logical_right_shift"><esi:assign name="x" value="$(ARGS{0})"/><esi:assign name="n" value="$(ARGS{1})"/><esi:assign name="size" value="32"/><esi:return value="($(x)>>$(n))&(~(((1<<$(size))>>$(n))<<1))"/></esi:function><esi:function name="power"><esi:assign name="n" value="$(ARGS{0})"/><esi:assign name="exp" value="$(ARGS{1})"/><esi:assign name="val" value="1"/><esi:choose><esi:when test="$(exp)>1"><esi:assign name="val" value="$(n)*$power($(n),$(exp)-1)"/></esi:when><esi:when test="$(exp)==1"><esi:assign name="val" value="$(n)"/></esi:when></esi:choose><esi:return value="$(val)"/></esi:function><esi:function name="toBase16"><esi:assign name="val" value="$(ARGS{0})"/><esi:assign name="ret" value="$(hexLookup{$(val)%16})"/><esi:assign name="val" value="$(val)/16"/><esi:choose><esi:when test="$(val)>0"><esi:assign name="ret" value="$toBase16($(val))+$str($(ret))"/></esi:when></esi:choose><esi:return value="$str($(ret))"/></esi:function><esi:assign name="hexLookup" value="'0123456789abcdef'"/><esi:function name="toBase10"><esi:assign name="hex" value="$(ARGS{0})"/><esi:choose><esi:when test="$is_empty($(hex))"><esi:return value="0"/></esi:when></esi:choose><esi:assign name="c" value="$index($(hexLookup),$(hex{0}))"/><esi:assign name="c" value="$(c)*$power(16,$len($(hex))-1)"/><esi:choose><esi:when test="$len($(hex))>1"><esi:assign name="c" value="$(c)+$toBase10($substr($(hex),1))"/></esi:when></esi:choose><esi:return value="$(c)"/></esi:function><esi:function name="toHex"><esi:assign name="number" value="$(ARGS{0})"/><esi:assign name="nstr" value="$toBase16($(number))"/><esi:choose><esi:when test="($len($(nstr))%2)==0"><esi:return value="$(nstr)"/></esi:when></esi:choose><esi:return value="'0'+$(nstr)"/></esi:function><esi:assign name="b64array" value="'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/='"/><esi:function name="hexToBase64"><esi:assign name="input" value="$(ARGS{0})"/><esi:assign name="b64value" value="''"/><esi:assign name="i" value="0"/><esi:foreach collection="[0..((($len($(input))+5)/6)-1)]" item="i"><esi:assign name="chr1" value="$toBase10($(input{($(i)*6)+0})+$(input{($(i)*6)+1}))"/><esi:assign name="chr2" value="$toBase10($(input{($(i)*6)+2})+$(input{($(i)*6)+3}))"/><esi:assign name="chr3" value="$toBase10($(input{($(i)*6)+4})+$(input{($(i)*6)+5}))"/><esi:assign name="enc1" value="$(chr1)>>2"/><esi:assign name="enc2" value="(($(chr1)&3)<<4)|($(chr2)>>4)"/><esi:assign name="enc3" value="(($(chr2)&15)<<2)|($(chr3)>>6)"/><esi:assign name="enc4" value="$(chr3)&63"/><esi:choose><esi:when test="(($(i)*6)+3)>$len($(input))"><esi:assign name="enc3" value="64"/><esi:assign name="enc4" value="$(enc3)"/></esi:when><esi:when test="(($(i)*6)+5)>$len($(input))"><esi:assign name="enc4" value="64"/></esi:when></esi:choose><esi:assign name="b64value" value="$(b64value)+($(b64array{$(enc1)})+$(b64array{$(enc2)})+$(b64array{$(enc3)})+$(b64array{$(enc4)}))"/></esi:foreach><esi:return value="$(b64value)"/></esi:function><esi:function name="base64toHex"><esi:assign name="input" value="$(ARGS{0})"/><esi:assign name="output" value="''"/><esi:assign name="i" value="0"/><esi:choose><esi:when test="($index($(input),'-')>=0)||($index($(input),'_')>=0)"><esi:assign name="input" value="$replace($replace($(input),'-','+'),'_','/')"/></esi:when></esi:choose><esi:foreach collection="[0..((($len($(input))+3)/4)-1)]" item="i"><esi:assign name="enc1" value="$index($(b64array),$(input{($(i)*4)+0}))"/><esi:assign name="enc2" value="$index($(b64array),$(input{($(i)*4)+1}|'='))"/><esi:assign name="enc3" value="$index($(b64array),$(input{($(i)*4)+2}|'='))"/><esi:assign name="enc4" value="$index($(b64array),$(input{($(i)*4)+3}|'='))"/><esi:assign name="chr1" value="($(enc1)<<2)|($(enc2)>>4)"/><esi:assign name="chr2" value="(($(enc2)&15)<<4)|($(enc3)>>2)"/><esi:assign name="chr3" value="(($(enc3)&3)<<6)|$(enc4)"/><esi:assign name="output" value="$(output)+$toHex($(chr1))"/><esi:choose><esi:when test="$(enc3)!=64"><esi:assign name="output" value="$(output)+$toHex($(chr2))"/></esi:when></esi:choose><esi:choose><esi:when test="$(enc4)!=64"><esi:assign name="output" value="$(output)+$toHex($(chr3))"/></esi:when></esi:choose></esi:foreach><esi:return value="$(output)"/></esi:function><esi:function name="base64url_decode"><esi:assign name="input" value="$(ARGS{0})"/><esi:assign name="input" value="$replace($replace($(input),'-','+'),'_','/')"/><esi:choose><esi:when test="($len($(input))%4)==2"><esi:assign name="input" value="$(input)+'=='"/></esi:when></esi:choose><esi:choose><esi:when test="($len($(input))%4)==3"><esi:assign name="input" value="$(input)+'='"/></esi:when></esi:choose><esi:return value="$base64_decode($(input))"/></esi:function><esi:function name="prepadSigned"><esi:assign name="hexStr" value="$(ARGS{0})"/><esi:assign name="msb" value="$index($(hexLookup),$(hexStr{0}))"/><esi:choose><esi:when test="$(msb)>=8"><esi:return value="'00'+$(hexStr)"/></esi:when><esi:otherwise><esi:return value="$(hexStr)"/></esi:otherwise></esi:choose></esi:function><esi:function name="encodeLengthHex"><esi:assign name="n" value="$(ARGS{0})"/><esi:choose><esi:when test="$(n)<=127"><esi:return value="$toHex($(n))"/></esi:when><esi:otherwise><esi:assign name="n_hex" value="$toHex($(n))"/><esi:assign name="length_of_length_byte" value="128+($len($(n_hex))/2)"/><esi:return value="$toHex($(length_of_length_byte))+$(n_hex)"/></esi:otherwise></esi:choose></esi:function><esi:function name="formatPem"><esi:assign name="value" value="$(ARGS{0})"/><esi:assign name="returnValue" value="$substr($(value),0,64)"/><esi:choose><esi:when test="$len($(value))>=64"><esi:assign name="returnValue">$(returnValue)+('
'+$formatPem($substr($(value),64)))</esi:assign></esi:when></esi:choose><esi:return value="$(returnValue)"/></esi:function><esi:function name="rsaPublicKeyPem"><esi:assign name="modulus_b64" value="$(ARGS{0}|'00')"/><esi:assign name="exponent_b64" value="$(ARGS{1}|'00')"/><esi:assign name="modulus_hex" value="$base64toHex($(modulus_b64))"/><esi:assign name="exponent_hex" value="$base64toHex($(exponent_b64))"/><esi:assign name="modulus_hex" value="$prepadSigned($(modulus_hex))"/><esi:assign name="exponent_hex" value="$prepadSigned($(exponent_hex))"/><esi:assign name="modlen" value="$len($(modulus_hex))/2"/><esi:assign name="explen" value="$len($(exponent_hex))/2"/><esi:assign name="encoded_modlen" value="$encodeLengthHex($(modlen))"/><esi:assign name="encoded_explen" value="$encodeLengthHex($(explen))"/><esi:assign name="encoded_pubkey" value="'30'+$encodeLengthHex($(modlen)+$(explen)+($len($(encoded_modlen))/2)+($len($(encoded_explen))/2)+2)+'02'+$(encoded_modlen)+$(modulus_hex)+'02'+$(encoded_explen)+$(exponent_hex)"/><esi:assign name="seq2" value="'300d'+'06092a864886f70d010101'+'0500'+'03'+$encodeLengthHex(($len($(encoded_pubkey))/2)+1)+'00'+$(encoded_pubkey)"/><esi:assign name="der_hex" value="'30'+$encodeLengthHex($len($(seq2))/2)+$(seq2)"/><esi:return value="'-----BEGIN PUBLIC KEY-----
'+$formatPem($hexToBase64($(der_hex)))+'
-----END PUBLIC KEY-----
'"/></esi:function><esi:function name="findCert"><esi:assign name="certs" value="$(ARGS{0})"/><esi:assign name="kid" value="$(ARGS{1}|'')"/><esi:assign name="key" value="$(certs{0})"/><esi:choose><esi:when test="$(key{'kid'})==$(kid)"><esi:return value="$(key)"/></esi:when></esi:choose><esi:choose><esi:when test="$len($(certs))>1">$list_delitem($(certs),0)<esi:return value="$findCert($(certs),$(kid))"/></esi:when></esi:choose><esi:return value="{}"/></esi:function><esi:function name="parseJWT"><esi:assign name="jwt" value="$(ARGS{0})"/><esi:assign name="parts" value="$string_split($(jwt),'.')"/><esi:assign name="header" value="$base64url_decode($(parts{0}))"/><esi:assign name="payload" value="$base64url_decode($(parts{1}))"/><esi:assign name="message" value="$(parts{0})+'.'+$(parts{1})"/><esi:assign name="signature" value="$(parts{2})"/><esi:choose><esi:when test="($len($(signature))%4)==2"><esi:assign name="signature" value="$(signature)+'=='"/></esi:when></esi:choose><esi:choose><esi:when test="($len($(signature))%4)==3"><esi:assign name="signature" value="$(signature)+'='"/></esi:when></esi:choose><esi:assign name="items">$string_split($(header),'"')</esi:assign><esi:assign name="kid" value="$(items{7}|$(items{5}|''))"/><esi:assign name="jwtObject" value="{'token':$(jwt),'header':$(header),'payload':$(payload),'message':$(message),'kid':$(kid),'signature':$(signature)}"/><esi:return value="$(jwtObject)"/></esi:function><esi:assign name="urlPrefix" value="''"/><esi:choose><esi:when test="!$exists($(AKA_PM_BASEDIR))"><esi:assign name="urlPrefix" value="'http://'+$(HTTP_HOST)"/></esi:when></esi:choose><esi:assign name="googleConfigUrl" value="'https://accounts.google.com/.well-known/openid-configuration'"/><esi:assign name="altUrl" value="$(urlPrefix)+'/google-openid-configuration.json'"/><esi:assign name="xhrUrl" value="$(urlPrefix)+'/esi/xhr2json.html?name=openidConfig&url='+$url_encode($(googleConfigUrl))+'&alt='+$url_encode($(altUrl))"/><esi:eval src="$(xhrUrl)" onerror="continue"/><esi:assign name="altUrl" value="$(urlPrefix)+'/google-jwks.json'"/><esi:assign name="xhrUrl" value="$(urlPrefix)+'/esi/xhr2json.html?name=jwks&url='+$url_encode($(openidConfig{'jwks_uri'}))+'&alt='+$url_encode($(altUrl))"/><esi:eval src="$(xhrUrl)" onerror="continue"/><esi:function name="getVerifyUrl"><esi:assign name="url" value="$(ARGS{0})"/><esi:assign name="jwt" value="$(ARGS{1})"/><esi:assign name="jwks" value="$(ARGS{2})"/><esi:assign name="jwt" value="$parseJWT($(jwt))"/><esi:assign name="key" value="$findCert($(jwks{'keys'}),$(jwt{'kid'}))"/><esi:assign name="modulus" value="$(key{'n'}|'00')"/><esi:assign name="exponent" value="$(key{'e'}|'00')"/><esi:choose><esi:when test="($(modulus)=='00')||($(exponent)=='00')"><esi:return value="$(url)"/></esi:when></esi:choose><esi:assign name="pem" value="$rsaPublicKeyPem($(modulus),$(exponent))"/><esi:assign name="pemUrlSafe">$replace($(pem),'
','\\n')</esi:assign>$add_header('Set-Cookie','data='+$(jwt{'message'})+'; Path=/; Secure; Max-Age=30;')$add_header('Set-Cookie','sig='+$(jwt{'signature'})+'; Path=/; Secure; Max-Age=30;')$add_header('Set-Cookie','pem='+$(pemUrlSafe)+'; Path=/; Secure; Max-Age=30;')<esi:return value="$(url)"/></esi:function><esi:assign name="jwt" value="$(QUERY_STRING{'access_token'}|'')"/><esi:assign name="url" value="$(QUERY_STRING{'url'}|'/data/verify')"/><esi:assign name="verifyUrl" value="$getVerifyUrl($(url),$(jwt),$(jwks))"/><esi:vars>$set_redirect($(verifyUrl))</esi:vars><esi:vars>$add_cachebusting_header()</esi:vars>